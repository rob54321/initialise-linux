#!/bin/bash

# Script to initialise raspberry pi
# this script is run after the first reboot
# and the system boots into the console not X windows.
# the subversion repository must exist.
# this script initialises the repositories for apt-get, makes all the devices, sets links for myenvironment, myrc.local and
# and installs subversion
usage() {
	echo "-d debian path [file:///mnt/hdd/debian|http://debian.mirror.ac.za/debian]	default: ${RPIURL}";
	echo "-m debhome path			default: ${MYDEBIANPATH}";
	echo "-r release name [buster]		default: ${RELEASE}";
	echo "-s svn path				default: ${SVNPATH}";
	echo "-l linklabel for hdd				default: ${LINKLABEL}";
	echo "-h help"
	exit
}

# defaults
# only for raspberry pi
RPIURL="http://deb.debian.org/debian"
SVNPATH="/home/robert/svn"
MYDEBIANPATH="/mnt/hdd/debhome"
LINKLABEL="ad64"
LINK="/mnt/${LINKLABEL}"
RELEASE="none"

while getopts d:m:s:l:r:h opt
do
	case ${opt} in
		d) RPIURL="${OPTARG}";;
		m) MYDEBIANPATH="${OPTARG}";;
		s) SVNPATH="${OPTARG}";;
		l) LINKLABEL="${OPTARG}";;
		r) RELEASE="${OPTARG}";;
		h) usage;;
		\?) usage;;
	esac
done

# set up the urls and path for debian or ubuntu
DISTROURL="${RPIURL}"

if [ "${RELEASE}" == "none" ]
then
	echo "Choose a release: stretch|buster etc"
	exit 1
fi

MYDEBIANURL="file://${MYDEBIANPATH}"

# make all the mount directories
chown robert.robert /mnt
cd /mnt
dirlist="hd2 hd3 ad64 ssd axiz axiz2 king sah trans ver ver8 chaos ad scd1 scd2"
for dir in $dirlist
do
	if [ ! -d /mnt/${dir} ]
	then
		mkdir /mnt/${dir}
	fi
done
# set permisions of /mnt dirs
chown robert.robert /mnt/*

# make the link for subversion
# so it can be accessed as file:///mnt/svn no matter where it is located
cd /mnt

if [ -L svn ]
then
	rm -f svn
fi
sudo -u robert ln -s ${SVNPATH} svn
SVNURL="file://${SVNPATH}"


# check the svn repository
if [ ! -e ${SVNPATH} ]
then
	echo "No subversion repository found at ${SVNPATH}"
	exit 1
fi

# make the hdd link
if [ -L hdd ]
then
	rm -f hdd
fi
sudo -u robert ln -s ${LINK} hdd

# mount the  flash drive for debhome if it is not mounted
findmnt ${LINK}
if [ $? -ne 0 ]
then
	mount -L ${LINKLABEL} ${LINK}
fi

#check for debhome
if [ ! -e ${MYDEBIANPATH} ]
then
	echo "No debhome repository found at ${MYDEBIANPATH}"
	exit 1
fi

# script to initialise sources.list, apt conf and
# setup everything to be able to mount the repository

# make sources.list for amd64
mv /etc/apt/sources.list /etc/apt/sources.list.bak

# edit sources.list for ubuntu or debian
echo "deb ${DISTROURL} ${RELEASE} main contrib non-free
deb ${DISTROURL} ${RELEASE}-security main contrib non-free
deb ${DISTROURL} ${RELEASE}-updates  main contrib non-free
deb ${MYDEBIANURL} home main"

> /etc/apt/sources.list

# make loop devices
# make the loop devices
for (( x = 0; x < 48; x += 1 ))
do
	if [ ! -b /dev/loop${x} ]
	then
    		mknod /dev/loop${x} b 7 ${x}
	fi
done
# set permissions of loop devices
chmod 666 /dev/loop*
chown root.root /dev/loop*

apt-key add ${MYDEBIANPATH}/publickeyFile.gpg
apt-get update
apt-get -y install subversion

# add all other config files so that no 'svn:externals' properties are necessary in the deb
# install files
cd /etc/sudoers.d
svn export --force ${SVNURL}/root/my-linux/sudoers.d/robert

# set ownership
chown root.root robert
chmod 0440 robertcd /etc

# setup fstab if it has not been setup already.
cd /etc
svn export --force ${SVNURL}/root/my-linux/config-files/fstab-extension /etc

# check if fstab-extention has been added to /etc/fstab
grep -q "fstab-extension" /etc
if [ $? -ne 0 ]
then
	# first backup it up
	cp -a /etc/fstab /etc/fstab.bak

	# append fstab extension to fstab
	cat /etc/fstab-extension >> /etc/fstab
fi
rm /etc/fstab-extension

# edit .bashrc so directories will be in colour for root
cd
cp -f .bashrc .bashrc.bak
sed -i -e 's/#force_color_prompt/force_color_prompt/' .bashrc

# edit .bashrc for robert so directories will be in colour
cd /home/robert
sed -i -e 's/#force_color_prompt/force_color_prompt/' .bashrc

# set up dircolors
cd /root
dircolors --print-database > .dircolors
sed -i -e 's/^DIR 01;34/DIR 01;36/' .dircolors
sed -i -e 's/^LINK 01;36/LINK 01;33/' .dircolors
cp /root/.dircolors /home/robert/
cd /home/robert
chown robert.robert /home/robert/.dircolors

chown robert.robert .bashrc

# set time to local
timedatectl set-timezone Africa/Johannesburg

#set link so boot only goes to command line
systemctl set-default multi-user.target
