#!/bin/bash

# Script to initialise raspberry pi
# this script is run automatically after init-rpi-first is run
# which will boot the pi and then run this script automatically.
# multi-user.target is set so that user pi can be changed to robert
# the clock and time zone are also set prior to this script
#
# the subversion repository must exist.
# this script initialises the repositories for apt-get, makes all the devices, sets links for myenvironment, myrc.local and
# and installs subversion

# disable the service that started this script
systemctl disable init-rpi.service
rm -v /etc/systemd/system/init-rpi.service

# change user pi to robert with correct groups and permissions
# check if user robert exists

# check the parameter list
if test $# -ne 1; then
	echo "SVNPATH required"
	exit 1;
fi

# parameter passed: the path to svn
SVNPATH="$1"

groups robert > /dev/null 2>&1
if test $? -ne 0; then
	# user robert does not exist, create it
	usermod -l robert -m -d /home/robert pi

	# if group pi exists, change it to group robert
	getent group pi
	if test $? -eq 0; then
		# change the group pi to robert
		groupmod -n robert pi
	fi
fi

# the link for svn must be set as it may
# have changed from /home/pi to /home/robert
cd /mnt/
rm -f svn
sudo -u robert ln -s "${SVNPATH}/svn" svn

# setup console
setupcon -f
